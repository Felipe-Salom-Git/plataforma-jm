rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userDocPath(uid) {
      return /databases/$(database)/documents/tenants/julian-marti/users/$(uid);
    }

    function isActiveMember() {
      return isSignedIn()
        && exists(userDocPath(request.auth.uid))
        && get(userDocPath(request.auth.uid)).data.active == true;
    }

    // ===== USERS (BOOTSTRAP) =====
    match /tenants/julian-marti/users/{userId} {

      // leer tu propio doc
      allow read: if isSignedIn() && request.auth.uid == userId;

      // crear tu doc una sola vez (bootstrap)
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && !exists(userDocPath(userId))
        && request.resource.data.active == true
        && request.resource.data.role == "owner";

      // opcional: permitir actualizar tu propio doc
      allow update: if isSignedIn() && request.auth.uid == userId;

      allow delete: if false;
    }

    // ===== COLECCIONES APP (WILDCARD) =====
    // Permite lectura/escritura en CUALQUIER documento bajo el tenant
    // siempre que el usuario sea miembro activo
    match /tenants/julian-marti/{document=**} {
      allow read, write: if isActiveMember();
    }

    // Default deny (todo lo dem√°s)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

